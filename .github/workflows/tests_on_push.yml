  name: CI
  on:
    push:
      branches:
        - master
  jobs:
    run_tests:
      runs-on: [ubuntu-latest]
      steps:
        - uses: actions/checkout@master
        - uses: actions/setup-python@v1
          with:
            python-version: 3.10.4
            architecture: 'x64'
        - name: Build image
          run: docker build -t postgres-app .
        - name: Docker-compose build
          run: docker-compose build
    build_and_pub:
      needs: [ run_tests ]
      runs-on: [ubuntu-latest]
      env:
        LOGIN: ${{secrets.DOCKER_LOGIN}}
        NAME: ${{secrets.DOCKER_NAME}}
      steps:
        - name: Login to docker
          run: echo ${{ secrets.DOCKER_TOKEN }} | docker login -u ${{ secrets.DOCKER_LOGIN }} --password-stdin
        - uses: actions/checkout@master
        - name: Build image
          run: docker-compose build -t $LOGIN/$NAME:${GITHUB_REF:11}
        - name: Push image to docker
          run: docker push $LOGIN/$NAME:${GITHUB_REF:11}